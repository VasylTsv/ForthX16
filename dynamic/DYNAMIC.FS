\ FORTH-94 VERSION OF KLAUS SCHLEISIEK'S DYNAMIC MEMORY ALLOCATION (FORML'88) UH 2016-10-28VARIABLE ANCHOR  0 ANCHOR !DECIMAL 050 CONSTANT WASTE-1 1 RSHIFT CONSTANT #MAX#MAX INVERT CONSTANT #FREE  \ SIGN BIT: SIZE ( MEM -- SIZE ) 1 CELLS - @ #MAX AND ;: ADDR&SIZE ( MEM -- MEM SIZE ) DUP SIZE ;: ABOVE ( MEM -- >MEM )   ADDR&SIZE + 2 CELLS + ;: USE ( MEM SIZE -- )    DUP >R SWAP  2DUP 1 CELLS - !  R> #MAX AND + ! ;: RELEASE ( MEM SIZE -- )   #FREE OR USE ;: FITS? ( SIZE -- MEM | FALSE ) >R ANCHOR @   BEGIN ADDR&SIZE  R@ U< 0=         IF R> DROP EXIT THEN         @ DUP ANCHOR @ =   UNTIL 0= R> DROP ;: LINK ( MEM >MEM <MEM -- )   >R 2DUP CELL+ !  OVER !  R> 2DUP !  SWAP CELL+ ! ;: @LINKS ( MEM -- <MEM MEM> )  DUP @  SWAP CELL+ @ ;: SETANCHOR ( MEM -- MEM )    DUP ANCHOR @ = IF  DUP @ ANCHOR ! THEN ;: UNLINK ( MEM -- ) SETANCHOR  @LINKS 2DUP !  SWAP CELL+ ! ;: ALLOCATE ( SIZE -- MEM IOR )   DUP 0< IF -1 EXIT THEN   3 CELLS MAX DUP >R  FITS? ?DUP 0= IF R> -8 EXIT THEN ( "DICTIONARY OVERFLOW" )   ADDR&SIZE R@ -  DUP WASTE U<   IF  DROP  DUP @ OVER UNLINK  OVER ADDR&SIZE USE   ELSE 2 CELLS -   OVER R@ USE        OVER ABOVE   DUP ROT RELEASE        2DUP SWAP @LINKS LINK THEN   R> DROP  ANCHOR ! 0 ;: FREE ( MEM -- IOR )   ADDR&SIZE  OVER 2 CELLS -  @ DUP 0<   IF #MAX AND 2 CELLS +  ROT OVER - ROT ROT +   ELSE  DROP  OVER ANCHOR @  DUP CELL+ @  LINK THEN   2DUP + CELL+ DUP @ DUP 0<   IF  #MAX AND SWAP CELL+ UNLINK  +  2 CELLS +  RELEASE 0 EXIT THEN   2DROP RELEASE 0 ;: RESIZE ( MEM NEWSIZE -- MEM' IOR )    DUP 0< IF EXIT THEN    OVER SWAP  OVER SIZE  2DUP >    IF ( MEM MEM SIZE NEWSIZE )  SWAP ALLOCATE ?DUP IF >R DROP 2DROP R>  EXIT THEN         DUP >R SWAP MOVE FREE R> SWAP EXIT THEN    2DROP DROP 0 ;: EMPTY-MEMORY ( ADDR SIZE -- )   >R  CELL+ DUP ANCHOR !   DUP 2 CELLS USE  DUP 2DUP LINK   DUP ABOVE  SWAP OVER  DUP LINK   DUP R> 7 CELLS -  RELEASE  ABOVE 1 CELLS -  0 SWAP ! ;CR CR .( DYNAMIC MEMORY ALLOCATION:)CR .( USE   ADDR SIZE EMPTY-MEMORY  TO INITIALIZE,)CR .( THEN USE THE STANDARD MEMORY ALLOCATION WORDSET ALLOCATE FREE RESIZE TO MANAGE MEMORY.)